<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Figma Plugin UI</title>
  
</head>
<body>

<!-- resize icon -->
<div id="resizeHandle" class="resize-handle">
  <svg width="16" height="16">
    <use href="#resize-icon"/>
  </svg>
</div>

<!-- Splash Screen -->
<div class="splash-screen" id="splashScreen">
  <img
    src=""
    alt="Welcome"
    class="splash-image"
    onload="console.log('Изображение успешно загружено')"
  >
  <div class="splash-content">
    <h1 class="splash-title"></h1>
    <button id="startCheck" class="button-main"></button>
  </div>
</div>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <!-- Добавляем SVG-спрайт в начало body -->
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
      <symbol id="instance-icon" viewBox="0 0 16 16">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.29289 2.29289C7.68342 1.90237 8.31658 1.90237 8.70711 2.29289L13.7071 7.29289C14.0976 7.68342 14.0976 8.31658 13.7071 8.70711L8.70711 13.7071C8.31658 14.0976 7.68342 14.0976 7.29289 13.7071L2.29289 8.70711C1.90237 8.31658 1.90237 7.68342 2.29289 7.29289L7.29289 2.29289ZM3.70711 8.70711L3 8L3.70711 7.29289L7.29289 3.70711L8 3L8.70711 3.70711L12.2929 7.29289L13 8L12.2929 8.70711L8.70711 12.2929L8 13L7.29289 12.2929L3.70711 8.70711Z"/>
      </symbol>
      <symbol id="info-icon" viewBox="0 0 16 16">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M13 8C13 10.7614 10.7614 13 8 13C5.23858 13 3 10.7614 3 8C3 5.23858 5.23858 3 8 3C10.7614 3 13 5.23858 13 8ZM14 8C14 11.3137 11.3137 14 8 14C4.68629 14 2 11.3137 2 8C2 4.68629 4.68629 2 8 2C11.3137 2 14 4.68629 14 8ZM7.48297 10.5355C7.48297 10.8195 7.71318 11.0497 7.99717 11.0497C8.28116 11.0497 8.51137 10.8195 8.51137 10.5355V7.20027C8.51137 6.91629 8.28116 6.68607 7.99717 6.68607C7.71318 6.68607 7.48297 6.91629 7.48297 7.20027V10.5355ZM7.57956 5.90482C7.69698 6.01277 7.83713 6.06675 8.00001 6.06675C8.16478 6.06675 8.30493 6.01277 8.42047 5.90482C8.53789 5.79497 8.5966 5.66334 8.5966 5.50993C8.5966 5.35463 8.53789 5.223 8.42047 5.11505C8.30493 5.0052 8.16478 4.95027 8.00001 4.95027C7.83713 4.95027 7.69698 5.0052 7.57956 5.11505C7.46213 5.223 7.40342 5.35463 7.40342 5.50993C7.40342 5.66334 7.46213 5.79497 7.57956 5.90482Z"/>
      </symbol>
      <symbol id="frame-icon" viewBox="0 0 16 16">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M5.5 3C5.77614 3 6 3.22386 6 3.5V5H10V3.5C10 3.22386 10.2239 3 10.5 3C10.7761 3 11 3.22386 11 3.5V5H12.5C12.7761 5 13 5.22386 13 5.5C13 5.77614 12.7761 6 12.5 6H11V10H12.5C12.7761 10 13 10.2239 13 10.5C13 10.7761 12.7761 11 12.5 11H11V12.5C11 12.7761 10.7761 13 10.5 13C10.2239 13 10 12.7761 10 12.5V11H6V12.5C6 12.7761 5.77614 13 5.5 13C5.22386 13 5 12.7761 5 12.5V11H3.5C3.22386 11 3 10.7761 3 10.5C3 10.2239 3.22386 10 3.5 10H5V6H3.5C3.22386 6 3 5.77614 3 5.5C3 5.22386 3.22386 5 3.5 5H5V3.5C5 3.22386 5.22386 3 5.5 3ZM10 10L10 6H6V10H10Z"/>
      </symbol>
      <symbol id="text-icon" viewBox="0 0 16 16">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M3 3.5C3 3.22386 3.22386 3 3.5 3H8H12.5C12.7761 3 13 3.22386 13 3.5V5C13 5.27614 12.7761 5.5 12.5 5.5C12.2239 5.5 12 5.27614 12 5V4H8.5V12H9.5C9.77614 12 10 12.2239 10 12.5C10 12.7761 9.77614 13 9.5 13H8H6.5C6.22386 13 6 12.7761 6 12.5C6 12.2239 6.22386 12 6.5 12H7.5V4H4V5C4 5.27614 3.77614 5.5 3.5 5.5C3.22386 5.5 3 5.27614 3 5V3.5Z"/>
      </symbol>
      <symbol id="rectangle-icon" viewBox="0 0 16 16">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M11.5 4H4.5C4.22386 4 4 4.22386 4 4.5V11.5C4 11.7761 4.22386 12 4.5 12H11.5C11.7761 12 12 11.7761 12 11.5V4.5C12 4.22386 11.7761 4 11.5 4ZM4.5 3C3.67157 3 3 3.67157 3 4.5V11.5C3 12.3284 3.67157 13 4.5 13H11.5C12.3284 13 13 12.3284 13 11.5V4.5C13 3.67157 12.3284 3 11.5 3H4.5Z"/>
      </symbol>
      <symbol id="select-all-icon" viewBox="0 0 24 24">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18ZM12 19C15.866 19 19 15.866 19 12C19 8.134 15.866 5 12 5C8.134 5 5 8.134 5 12C5 15.866 8.134 19 12 19ZM12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15ZM12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16ZM13 12C13 12.5523 12.5523 13 12 13C11.4477 13 11 12.5523 11 12C11 11.4477 11.4477 11 12 11C12.5523 11 13 11.4477 13 12Z"/>
      </symbol>
      <symbol id="resize-icon" viewBox="0 0 24 24">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M11.5219 16H11.5H8.5C8.22386 16 8 15.7761 8 15.5C8 15.2239 8.22386 15 8.5 15H11.5C12.2083 15 12.7095 14.9996 13.1013 14.9676C13.4872 14.9361 13.7228 14.8764 13.908 14.782C14.2843 14.5903 14.5903 14.2843 14.782 13.908C14.8764 13.7228 14.9361 13.4872 14.9676 13.1013C14.9996 12.7095 15 12.2083 15 11.5V8.5C15 8.22386 15.22386 8 15.5 8C15.7761 8 16 8.22386 16 8.5V11.5V11.5219C16 12.2034 16 12.7454 15.9643 13.1827C15.9277 13.6305 15.8512 14.0123 15.673 14.362C15.3854 14.9265 14.9265 15.3854 14.362 15.673C15.0123 15.8512 15.6305 15.9277 15.1827 15.9643C12.7454 16 12.2034 16 11.5219 16Z"/>
      </symbol>
    </svg>
   
  <!-- Loader --> 
  <div class="loader-container">
    <div class="progress-info">
      <div class="progress-counts">Обработано: <span id="processedCount">0</span> из <span id="totalCount">0</span></div>
      <div class="progress-bar">
        <div class="progress-bar-fill" id="progressBarFill"></div>
      </div>
      <div class="progress-phase" id="progressPhase"></div>
    </div>
  </div>
  
  <!-- Весь контент --> 
  <div class="container">
    <!-- Header --> 
    <div class="header">
    <!-- Кнопка --> 
      <div class="button-wrapper">
        <button id="checkAll" class="button-main">New search</button>
        <button id="check-updates" class="button-main">Updates</button>
        <div class="switch-container">
          <label for="showHiddenToggle" class="switch" style="text-decoration: none; cursor: pointer;">
            <input type="checkbox" id="showHiddenToggle" class="checkbox" checked>
            <span class="slider round"></span>
          </label>hidden
        </div>
      </div>
      <!-- Tabs --> 
      <div class="tabs">
        <div class="tab active" data-tab="instances">All instances</div>
        <div class="tab" data-tab="colors">Colors</div>
        <div class="tab_disabled" data-tab="deprecated">Deprecated (soon)</div>
        <div class="tab_disabled" data-tab="detached">Detached (soon)</div>
        <div class="tab" data-tab="outdated">Outdated</div>
        <div class="tab" data-tab="lost">Lost</div>
        <div class="tab" data-tab="icons">Icons</div>
        <div class="tab" data-tab="total">Total</div>
      </div>
    </div>
    <!-- Контент --> 
    <div class="tabs-content"> 
      <!-- Все инстансы --> 
      <div id="instances" class="tab-content active">
        <div id="results">
          <a href="#" class="toggle-groups" data-action="expand">expand all</a>
        <ul id="resultsList"></ul>
      </div>
    </div>

    <!-- Устаревшие инстансы -->
    <div id="outdated" class="tab-content">
      <div id="outdatedResults">
        <a href="#" class="toggle-groups" data-action="expand">expand all</a>
        <ul id="outdatedResultsList"></ul>
      </div>
    </div>

    <!-- Потерянные инстансы -->
    <div id="lost" class="tab-content">
      <div id="lostResults">
        <a href="#" class="toggle-groups" data-action="expand">expand all</a>
        <ul id="lostResultsList"></ul>
      </div>
    </div>
    <!-- Changelog --> 
    <div id="log" class="tab-content">
      <h3>ToDo</h3>
      <p class="todo">Причесать UI
        <br>Не все иконки определяются корректно
        <br>Заменить hidden на иконку и добавить к группам из 1 элемента
        <br>В инстансах переписать вывод аналогично группам
        <br> Проверять fillStyleId для цветов
        <br> Поправить тег группы если внутри разные версии
        <br> Дополнительно в цветах группировать по типу элемента
      </p>
    </div>
    <!-- Иконки --> 
    <div id="icons" class="tab-content">
      <div id="iconResults">
        <a href="#" class="toggle-groups" data-action="expand">expand all</a>
        <ul id="iconResultsList"></ul>
      </div>
    </div>
    <!-- Цвета --> 
    <div id="colors" class="tab-content">
      <div id="colorResults">
        <a href="#" class="toggle-groups" data-action="expand">expand all</a>
        <ul id="colorResultsList"></ul>
        <ul id="colorStrokeResultsList"></ul>
      </div>
    </div>
    <!-- Total Statistics -->
    <div id="total" class="tab-content">
        <div class="stats-section">
          <ul id="overallStatsList" class="stats-list"></ul>
        </div>
    </div>
    <!-- Plugin Data --> 
    <div id="component-data" class="tab-content"> 
      <h3>PluginData</h3>
      <p>Это трогать не надо!</p>
      <div style="margin-bottom: 15px;">
        <label for="componentKey">Ключ компонента:</label>
        <input type="text" id="componentKey" placeholder="Введите ключ" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
      </div>
      
      <div style="margin-bottom: 15px;">
        <label for="componentVersion">Версия компонента:</label>
        <input type="text" id="componentVersion" placeholder="Например, 1.0.0" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
      </div>
        
      <div class="small-button-wrapper">
        <button id="readComponentData" class="button-secondary">Прочитать данные</button>
        <button id="setComponentData" class="button-secondary">Установить данные</button>
        <button id="clearComponentData" class="button-secondary">Очистить данные</button>
      </div>
      
      <div id="componentDataOutput" style="margin-top: 20px; min-height: 100px; border: 1px solid #eee; border-radius: 4px; padding: 10px; background-color: #f9f9f9;">
        <p class="placeholder-text" style="color: #888; font-style: italic;">Здесь будет отображаться результат операций.</p>
      </div>
    </div>
    <!-- Debug --> 
    <div id="debug" class="tab-content">
      <h3>RAW Data</h3>
      <div class="search-container">
        <input type="text" id="debugSearchInput" placeholder="Поиск в отладочной информации...">
      </div>
      <div id="debugContent" class="debug-tree"></div>
    </div>
  </div>
  <!-- Footer --> 
    <div class='footer'><div class='wrapper'>
      <div class="user-info"></div>
      <div class="tabs">
        <div class="tab" id='metadata' data-tab="component-data">Metadata</div>
        <div class="tab" data-tab="debug">Debug</div>
        <div class="tab" data-tab="log">Backlog</div> 
      </div>
  </div></div>

<script>
console.log('Script started'); // Added log

// Проверяем наличие элементов
const splashScreen = document.getElementById('splashScreen');
const splashImage = document.querySelector('.splash-image');
const loaderContainer = document.querySelector('.loader-container');
const processedCount = document.getElementById('processedCount');
const totalCount = document.getElementById('totalCount');
const progressBarFill = document.querySelector('.progress-bar-fill');
const checkUpdatesButton = document.getElementById('check-updates');


document.addEventListener('DOMContentLoaded', function() {
    
  // Инициализация вкладок
  const tabs = document.querySelectorAll('.tab[data-tab]'); // Выбираем только вкладки с атрибутом data-tab
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const tabId = tab.getAttribute('data-tab');
            
      // Показываем соответствующий контент
      document.querySelectorAll('.tab-content').forEach(content => {
          content.style.display = content.id === tabId ? 'block' : 'none';
      });
            
      // Обновляем активную вкладку
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      });
  });

    

    if (checkUpdatesButton) {
      checkUpdatesButton.addEventListener('click', () => {
        // Check if we have component data
        if (!window.lastDebugData?.components?.instances?.length) {
          // Show error message if no components data available
          const errorDiv = document.createElement('div');
          errorDiv.className = 'error-message';
          const errorText = document.createElement('p');
          errorText.textContent = 'Пожалуйста, сначала выполните поиск компонентов';
          errorDiv.appendChild(errorText);
          document.body.appendChild(errorDiv);
          
          setTimeout(() => {errorDiv.remove();}, 3000);
          return;
        }

        // Show loader
        loaderContainer.style.display = 'flex';
        
        // Reset progress
        processedCount.textContent = '0';
        totalCount.textContent = '0';
        progressBarFill.style.width = '0%';
        
        // Show phase
        document.getElementById('progressPhase').textContent = 'Проверка обновлений...';
        
        // Send message to backend
        parent.postMessage({ 
          pluginMessage: { 
            type: 'check-updates',
            components: window.lastDebugData.components // Send cached component data
          } 
        }, '*');
      });
    }
});
      
      
    
    
    // Добавляем обработчик для кнопки на splash screen
    document.getElementById('startCheck').addEventListener('click', () => {
      //console.log('Кнопка startCheck нажата');
      const loaderContainer = document.querySelector('.loader-container');
      loaderContainer.style.display = 'flex';
      
      // Скрываем splash screen и показываем основной контент
      document.getElementById('splashScreen').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
      
      // Запускаем проверку
      parent.postMessage({ pluginMessage: { type: 'check-all' } }, '*');
    });

    document.getElementById('checkAll').addEventListener('click', () => {
      const loaderContainer = document.querySelector('.loader-container');
      loaderContainer.style.display = 'flex';
      parent.postMessage({ pluginMessage: { type: 'check-all' } }, '*');
    });


    // Обработчик для кнопки "Прочитать данные"
    document.getElementById('readComponentData').addEventListener('click', function() {
        //console.log('Запрос на чтение данных компонента');
        parent.postMessage({ pluginMessage: { type: 'get-component-data' } }, '*');
      });


// Обработчик для кнопки "Установить данные"
document.getElementById('setComponentData').addEventListener('click', function() {
        const key = document.getElementById('componentKey').value.trim();
        const version = document.getElementById('componentVersion').value.trim();
        
        //console.log('Запрос на установку данных компонента:', { key, version });
        
        if (!key || !version) {
          UIModules.displayResult('Пожалуйста, введите ключ и версию компонента.', true);
          return;
        }
        
        parent.postMessage({pluginMessage: {type: 'set-component-data', key, version}}, '*');
      });
      
      // Обработчик для кнопки "Очистить данные"
      document.getElementById('clearComponentData').addEventListener('click', function() {
        //console.log('Запрос на очистку данных компонента');
        parent.postMessage({ pluginMessage: { type: 'clear-component-data' } }, '*');
      });

    
   
    const tabs = document.querySelectorAll('.tab');
    
    const tabContents = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        // Deactivate all tabs and tab contents
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(tc => tc.classList.remove('active'));
        // Activate the clicked tab and its corresponding content
        tab.classList.add('active');
        const target = document.getElementById(tab.dataset.tab);
        target.classList.add('active');
      });
    });
    
   



    // Add after the existing tab switching logic
    document.querySelectorAll('.toggle-groups').forEach(toggle => {
      toggle.addEventListener('click', (e) => {
        e.preventDefault();
        const container = e.target.closest('div');
        const groupItems = container.querySelectorAll('.group-items');
        const isExpanding = e.target.dataset.action === 'expand';

        // Toggle all groups
        groupItems.forEach(group => {
          group.classList.toggle('expanded', isExpanding);
        });

        // Update toggle text and action
        e.target.textContent = isExpanding ? 'collapse all' : 'expand all';
        e.target.dataset.action = isExpanding ? 'collapse' : 'expand';
      });
    });


    // Добавляем обработчик для нового toggle "Show hidden"
    const showHiddenToggle = document.getElementById('showHiddenToggle');
    if (showHiddenToggle) {
        showHiddenToggle.addEventListener('change', () => {
            // Перерисовываем список инстансов при изменении состояния toggle
            if (window.lastDebugData) {
                if (window.lastDebugData.components) {
                    const resultsList = document.getElementById('resultsList');
                    const iconResultsList = document.getElementById('iconResultsList');
                    let allInstances = [];
                    UIModules.processAndDisplayComponents(window.lastDebugData.components, allInstances, resultsList, iconResultsList);
                }
                if (window.lastDebugData.components) {
            const outdatedResultsList = document.getElementById('outdatedResultsList');
            let allInstances = [];
            UIModules.processAndDisplayComponents(window.lastDebugData.components, allInstances, outdatedResultsList, null, 'outdated');
        }
                if (window.lastDebugData.components) {
            const lostResultsList = document.getElementById('lostResultsList');
            let allInstances = [];
            UIModules.processAndDisplayComponents(window.lastDebugData.components, allInstances, lostResultsList, null, 'lost');
        }
                // Re-process and display colors
                UIModules.processAndDisplayColors(window.lastDebugData.colors, window.lastDebugData.colorsStroke);
            }
        });
    }
    const searchInput = document.getElementById('searchInput');
    const clearSearch = document.getElementById('clearSearch');
    const searchResults = document.getElementById('searchResults');
    const debugContent = document.getElementById('debug').querySelector('#debugContent');
    let allInstances = []; // Store all instances for searching
    let originalDebugContent = null;

    const debugSearchInput = document.getElementById('debugSearchInput');
    const debugClearSearch = document.getElementById('debugClearSearch');

    // Добавляем обработчик для поиска в debug
    debugSearchInput.addEventListener('input', function() {
      const searchTerm = this.value.trim();
      //console.log('Debug search term:', searchTerm);

      // Если это первый поиск, сохраняем оригинальное содержимое
      if (!originalDebugContent) {
        originalDebugContent = debugContent.innerHTML;
      }

      // Если поле поиска пустое, восстанавливаем оригинальное содержимое
      if (!searchTerm) {
        debugContent.innerHTML = originalDebugContent;
        return;
      }

      // Пересоздаем дерево с учетом поискового запроса
        const debugData = {
          type: 'debug-search',
          components: window.lastDebugData?.components || {},
          colors: window.lastDebugData?.colors || {},
          componentTree: window.lastDebugData?.componentTree || null,
          totalStats: window.lastDebugData?.totalStats || {}
        };

        debugContent.innerHTML = '';
        const newTree = UIModules.createDebugTree(debugData, searchTerm);
        if (newTree) {
          debugContent.appendChild(newTree);
        }
    });

    // Обновляем обработчик сообщений для сохранения данных отладки
    // Define displayComponentData in the global scope first
    window.displayComponentData = function(data) {
      const outputElement = document.getElementById('componentDataOutput');
      if (!outputElement) {
        console.error('Элемент вывода не найден');
        return;
      }

      outputElement.innerHTML = '';

      if (!data || Object.keys(data).length === 0) {
        UIModules.displayResult('Данные компонента не найдены.', true);
        return;
      }

      const container = document.createElement('div');
      container.style.fontFamily = 'monospace';

      for (const nodeId in data) {
        const nodeData = data[nodeId];

        const nodeTitle = document.createElement('h4');
        nodeTitle.textContent = `Компонент: ${nodeData.name || 'Без имени'}`;
        nodeTitle.style.marginBottom = '5px';
        container.appendChild(nodeTitle);

        const nodeInfo = document.createElement('div');
        nodeInfo.style.marginLeft = '10px';
        nodeInfo.style.marginBottom = '15px';

        const idLine = document.createElement('div');
        idLine.textContent = `ID: ${nodeId}`;
        nodeInfo.appendChild(idLine);

        const keyLine = document.createElement('div');
        keyLine.textContent = `Ключ: ${nodeData.key || 'Не установлен'}`;
        keyLine.style.color = nodeData.key ? '#2e7d32' : '#d32f2f';
        nodeInfo.appendChild(keyLine);

        const versionLine = document.createElement('div');
        versionLine.textContent = `Версия: ${nodeData.version || 'Не установлена'}`;
        versionLine.style.color = nodeData.version ? '#2e7d32' : '#d32f2f';
        nodeInfo.appendChild(versionLine);

        if (nodeData.originalKey) {
          const originalKeyLine = document.createElement('div');
          originalKeyLine.textContent = `Оригинальный ключ: ${nodeData.originalKey}`;
          originalKeyLine.style.color = '#666';
          nodeInfo.appendChild(originalKeyLine);
        }

        container.appendChild(nodeInfo);
      }

      outputElement.appendChild(container);
    };

    // Then define the message handler
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;
      
      // Handle special cases first
      if (msg.type === 'user-info') {
        const userInfoElement = document.querySelector('.user-info');
        const metadataTab = document.getElementById('metadata');
        if (userInfoElement) {
          if (!["Konstantin Kuzin", "III", "YYY"].includes(msg.user.name)) metadataTab.style.display = 'none';
          userInfoElement.textContent = msg.user.name;
        }
        return;
      }
      
      // Handle splash-data message
      if (msg.type === 'splash-data') {
        const splashImageElement = document.querySelector('.splash-image');
        const splashTitleElement = document.querySelector('.splash-title');
        const startCheckButton = document.getElementById('startCheck');

        if (splashImageElement && msg.data.imageUrl) {
          splashImageElement.src = msg.data.imageUrl;
        }
        if (splashTitleElement && msg.data.titleText) {
          splashTitleElement.textContent = msg.data.titleText;
        }
        if (startCheckButton && msg.data.buttonText) {
          startCheckButton.textContent = msg.data.buttonText;
        }
        return;
      }

      if (msg.type === 'resize') {
        const width = msg.width;
        const height = msg.height;
        window.resizeTo(width, height);
        return;
      }

      if (msg.type === 'display-total') {
        UIModules.displayTotal(msg.data);
        return;
      }

      if (msg.type === 'success') {
        hideLoader();
        
        // Очищаем предыдущие результаты
        const resultsList = document.getElementById('colorResultsList');
        if (resultsList) {
          resultsList.innerHTML = '';
          
          if (msg.instances && msg.instances.length > 0) {UIModules.displayGroups(msg.instances, resultsList, msg.counts);
          } else {resultsList.innerHTML = '<p>Цвета не найдены</p>';}} 
          else {
          //console.error('Не найден элемент colorResultsList');
        }
      } 
      if (msg.type === 'progress-update') {
        // Показываем контейнер загрузки, если он еще не показан
        loaderContainer.style.display = 'flex';
        
        // Обновляем информацию о прогрессе
        processedCount.textContent = msg.processed;
        totalCount.textContent = msg.total;
        
        // Обновляем прогресс-бар
        const percentage = (msg.processed / msg.total) * 100;
        progressBarFill.style.width = `${percentage}%`;
        // Показываем имя компонента
        if (msg.currentComponentName) {
          document.getElementById('progressPhase').textContent = `${msg.currentComponentName}`;
        } else if (msg.type === 'progress-update' && msg.phase === 'check-updates') {
          document.getElementById('progressPhase').textContent = 'Проверка обновлений...';
        } else {
          document.getElementById('progressPhase').textContent = '';
        }
      } 
      if (msg.type === 'all-results') {
        // Save data for search
        window.lastDebugData = {
          components: msg.components,
          colors: msg.colors,
          colorsStroke: msg.colorsStroke,
          componentTree: msg.componentTree,
          totalStats: msg.totalStats
        };

        // Hide loader
        const loaderContainer = document.querySelector('.loader-container');
        if (loaderContainer) {loaderContainer.style.display = 'none';}

        console.log('Received all-results:', msg);

        // Process components
        if (msg.components) {
            const resultsList = document.getElementById('resultsList');
            const iconResultsList = document.getElementById('iconResultsList');
            let allInstances = [];
            UIModules.processAndDisplayComponents(msg.components, allInstances, resultsList, iconResultsList);
        }
        
        // Process outdated components if present
        if (msg.components) {
            const outdatedResultsList = document.getElementById('outdatedResultsList');
            let allInstances = [];
            UIModules.processAndDisplayComponents(msg.components, allInstances, outdatedResultsList, null, 'outdated');
        }

        // Process lost components if present
        if (msg.components) {
            const lostResultsList = document.getElementById('lostResultsList');
            let allInstances = [];
            UIModules.processAndDisplayComponents(msg.components, allInstances, lostResultsList, null, 'lost');
        }

        // Process colors
        if (msg.colors) {
            UIModules.processAndDisplayColors(msg.colors, msg.colorsStroke);
        }

        // Update debug information
        debugContent.innerHTML = '';
        debugContent.className = 'debug-tree';

        // Create formatted debug output
        const debugData = {
          type: msg.type,
          timestamp: new Date().toISOString(),
          components: msg.components,
          colors: msg.colors,
          colorsStroke: msg.colorsStroke,
          componentTree: msg.componentTree,
          totalStats: msg.totalStats
        };

        // Сбрасываем сохраненное оригинальное содержимое при новых данных
        originalDebugContent = null;

        // Преобразуем данные в древовидную структуру
        const tree = UIModules.createDebugTree(debugData);
        if (tree) {
          debugContent.appendChild(tree);
          //console.log('Отладочная информация обновлена');
        } else {
          //console.error('Не удалось создать дерево отладки');
        }
      } 
      if (msg.type === 'error') {
          loaderContainer.style.display = 'none';
        
          // Удаляем предыдущее сообщение об ошибке, если оно есть
          const existingError = document.querySelector('.error-message');
          if (existingError) {
            existingError.remove();
          }
          
          // Создаем новое сообщение об ошибке
          const errorDiv = document.createElement('div');
          errorDiv.className = 'error-message';
          const errorText = document.createElement('p');
          errorText.textContent = msg.message;
          errorDiv.appendChild(errorText);
          document.body.appendChild(errorDiv);
          
          // Автоматически скрываем сообщение через 3 секунды
          setTimeout(() => {errorDiv.remove();}, 5000);
        
          // Добавляем ошибку в отладочную информацию
          const debugError = document.createElement('div');
          debugError.style.color = 'red';
          debugError.textContent = `Error: ${msg.message}`;
          debugContent.appendChild(debugError);
          }

      if (msg.type === 'component-data-result') {
        if (msg.data) {
          displayComponentData(msg.data);
        } else if (msg.message) {
          UIModules.displayResult(msg.message, msg.isError);
        } else {
          UIModules.displayResult('Данные компонента не найдены.');
        }
        return;
      }

      if (msg.type === 'component-data-set') {
        UIModules.displayResult(msg.message || 'Данные компонента успешно установлены.', msg.isError);
        return;
      }

      if (msg.type === 'component-data-cleared') {
        UIModules.displayResult(msg.message || 'Данные компонента успешно очищены.', msg.isError);
        return;
      }


// Выполняем после загрузки страницы
    window.addEventListener('DOMContentLoaded', function() {
      console.log('Инициализация функций для работы с компонентами');

      // Определяем глобальную функцию displayComponentData
      window.displayComponentData = function(data) {
        const outputElement = document.getElementById('componentDataOutput');
        if (!outputElement) {
          console.error('Элемент вывода не найден');
          return;
        }

        outputElement.innerHTML = '';

        if (!data || Object.keys(data).length === 0) {
          UIModules.displayResult('Данные компонента не найдены.', true);
          return;
        }

        const container = document.createElement('div');
        container.style.fontFamily = 'monospace';

        for (const nodeId in data) {
          const nodeData = data[nodeId];

          const nodeTitle = document.createElement('h4');
          nodeTitle.textContent = `Компонент: ${nodeData.name || 'Без имени'}`;
          nodeTitle.style.marginBottom = '5px';
          container.appendChild(nodeTitle);

          const nodeInfo = document.createElement('div');
          nodeInfo.style.marginLeft = '10px';
          nodeInfo.style.marginBottom = '15px';

          const idLine = document.createElement('div');
          idLine.textContent = `ID: ${nodeId}`;
          nodeInfo.appendChild(idLine);

          const keyLine = document.createElement('div');
          keyLine.textContent = `Ключ: ${nodeData.key || 'Не установлен'}`;
          keyLine.style.color = nodeData.key ? '#2e7d32' : '#d32f2f';
          nodeInfo.appendChild(keyLine);

          const versionLine = document.createElement('div');
          versionLine.textContent = `Версия: ${nodeData.version || 'Не установлена'}`;
          versionLine.style.color = nodeData.version ? '#2e7d32' : '#d32f2f';
          nodeInfo.appendChild(versionLine);

          // Добавляем отображение данных из PluginData
          if (nodeData.pluginDataKey || nodeData.pluginDataVersion) {
            // Добавляем заголовок для данных из PluginData
            const pluginDataHeader = document.createElement('div');
            pluginDataHeader.textContent = 'Данные из PluginData:';
            pluginDataHeader.style.fontWeight = 'bold';
            pluginDataHeader.style.marginTop = '8px';
            pluginDataHeader.style.marginBottom = '4px';
            nodeInfo.appendChild(pluginDataHeader);

            // Отображаем ключ из PluginData
            const pluginDataKeyLine = document.createElement('div');
            pluginDataKeyLine.textContent = `Ключ из PluginData: ${nodeData.pluginDataKey || 'Не установлен'}`;
            pluginDataKeyLine.style.color = nodeData.pluginDataKey ? '#2e7d32' : '#d32f2f';
            pluginDataKeyLine.style.marginLeft = '10px';
            nodeInfo.appendChild(pluginDataKeyLine);

            // Отображаем версию из PluginData
            const pluginDataVersionLine = document.createElement('div');
            pluginDataVersionLine.textContent = `Версия из PluginData: ${nodeData.pluginDataVersion || 'Не установлена'}`;
            pluginDataVersionLine.style.color = nodeData.pluginDataVersion ? '#2e7d32' : '#d32f2f';
            pluginDataVersionLine.style.marginLeft = '10px';
            nodeInfo.appendChild(pluginDataVersionLine);
          }

          container.appendChild(nodeInfo);
        }

        outputElement.appendChild(container);
      };

      // Переопределяем обработчик сообщений
      const originalMessageHandler = window.onmessage;
      window.addEventListener('message', function(event) {
        if (!event.data.pluginMessage) return;

        const msg = event.data.pluginMessage;
        //console.log('Получено сообщение от плагина:', msg);

        // Обработка сообщений для компонентов
        switch (msg.type) {
          case 'component-data-result':
            if (msg.data) {
              console.log('Отображение данных компонента:', msg.data);
              const outputElement = document.getElementById('componentDataOutput');
              if (!outputElement) {
                console.error('Элемент вывода не найден');
                return;
              }

              outputElement.innerHTML = '';

              if (Object.keys(msg.data).length === 0) {
                UIModules.displayResult('Данные компонента не найдены.', true);
                return;
              }

              const container = document.createElement('div');
              container.style.fontFamily = 'monospace';

              for (const nodeId in msg.data) {
                const nodeData = msg.data[nodeId];

                const nodeTitle = document.createElement('h4');
                nodeTitle.textContent = `Компонент: ${nodeData.name || 'Без имени'}`;
                nodeTitle.style.marginBottom = '5px';
                container.appendChild(nodeTitle);

                const nodeInfo = document.createElement('div');
                nodeInfo.style.marginLeft = '10px';
                nodeInfo.style.marginBottom = '15px';

                const idLine = document.createElement('div');
                idLine.textContent = `ID: ${nodeId}`;
                nodeInfo.appendChild(idLine);

                const keyLine = document.createElement('div');
                keyLine.textContent = `Ключ: ${nodeData.key || 'Не установлен'}`;
                keyLine.style.color = nodeData.key ? '#2e7d32' : '#d32f2f';
                nodeInfo.appendChild(keyLine);

                const versionLine = document.createElement('div');
                versionLine.textContent = `Версия: ${nodeData.version || 'Не установлена'}`;
                versionLine.style.color = nodeData.version ? '#2e7d32' : '#d32f2f';
                nodeInfo.appendChild(versionLine);

                if (nodeData.originalKey) {
                  const originalKeyLine = document.createElement('div');
                  originalKeyLine.textContent = `Оригинальный ключ: ${nodeData.originalKey}`;
                  originalKeyLine.style.color = '#666';
                  nodeInfo.appendChild(originalKeyLine);
                }

                container.appendChild(nodeInfo);
              }

              outputElement.appendChild(container);
            } else if (msg.message) {
              UIModules.displayResult(msg.message, msg.isError);
            } else {
              UIModules.displayResult('Данные компонента не найдены.');
            }
            break;

          case 'component-data-set':
            UIModules.displayResult(msg.message || 'Данные компонента успешно установлены.', msg.isError);
            break;

          case 'component-data-cleared':
            UIModules.displayResult(msg.message || 'Данные компонента успешно очищены.', msg.isError);
            break;
        }
      });

      console.log('Инициализация завершена');
    });
    
    };

        

    // Обработка ресайза окна
        const resizeHandle = document.getElementById('resizeHandle');
        let isResizing = false;
        let initialWidth;
        let initialHeight;
        let initialX;
        let initialY;

    resizeHandle.addEventListener('mousedown', (e) => {
      isResizing = true;
      initialWidth = window.innerWidth;
      initialHeight = window.innerHeight;
      initialX = e.clientX;
      initialY = e.clientY;
    });
      
    document.addEventListener('mousemove', (e) => {
      if (!isResizing) return;
      
      const newWidth = initialWidth + (e.clientX - initialX);
      const newHeight = initialHeight + (e.clientY - initialY);
      
      // Ensure minimum dimensions
      const width = Math.max(newWidth, 300);
      const height = Math.max(newHeight, 200);
      
      // Directly resize the window
      window.resizeTo(width, height);
      
      // Also notify the plugin
      parent.postMessage({ 
        pluginMessage: { 
          type: 'resize', 
          width: width,
          height: height
        } 
      }, '*');

      // Prevent selection during resize
      e.preventDefault();
    });
      
    document.addEventListener('mouseup', () => {isResizing = false;}); 
    
    


    // Functions moved to UIModules

    // Search functionality
    if (searchInput && clearSearch && searchResults) {
      searchInput.addEventListener('input', () => {
        const searchTerm = searchInput.value.toLowerCase();
        clearSearch.style.display = searchTerm ? 'block' : 'none';

        if (!searchTerm) {
          searchResults.innerHTML = '';
          return;
        }

        const results = allInstances.filter(instance => {
          const name = instance.name.toLowerCase();
          const description = (instance.description || '').toLowerCase();
          return name.includes(searchTerm) || description.includes(searchTerm);
        });

        UIModules.displaySearchResults(results, searchTerm);
      });

      // Clear search
      clearSearch.addEventListener('click', () => {
        searchInput.value = '';
        searchResults.innerHTML = '';
        clearSearch.style.display = 'none';
      });
    }

    // Functions moved to UIModules

    // Removed duplicate check-updates handler and redundant inputs init (moved earlier)

</script>
</body>
</html>
